schemaVersion: '0.3'
description: 'Remediate SSH access violations by removing public SSH ingress rules'
assumeRole: '{{ AutomationAssumeRole }}'
parameters:
  configRuleName:
    type: String
    description: 'Name of the Config rule that triggered this automation'
  resourceId:
    type: String
    description: 'Resource ID that is non-compliant'
  resourceType:
    type: String
    description: 'Type of resource that is non-compliant'
  AutomationAssumeRole:
    type: String
    description: 'IAM role for automation execution'
    default: 'arn:aws:iam::{{global:ACCOUNT_ID}}:role/imladris-{{ssm:environment}}-remediation-role'

mainSteps:
  - name: IdentifyResourceType
    action: 'aws:branch'
    inputs:
      Choices:
        - NextStep: RemediateSecurityGroup
          Variable: '{{ resourceType }}'
          StringEquals: 'AWS::EC2::SecurityGroup'
        - NextStep: LogUnsupportedResource
          Variable: '{{ resourceType }}'
          StringEquals: 'AWS::EC2::Instance'
      Default: LogUnsupportedResource

  - name: RemediateSecurityGroup
    action: 'aws:executeAwsApi'
    description: 'Remove SSH ingress rules from security group'
    inputs:
      Service: ec2
      Api: AuthorizeSecurityGroupIngress
      GroupId: '{{ resourceId }}'
      IpPermissions:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          IpRanges:
            - CidrIp: 0.0.0.0/0
              Description: 'Removed by Imladris Auto-Remediation'
    isEnd: true
    onFailure: Abort

  - name: LogUnsupportedResource
    action: 'aws:executeAwsApi'
    description: 'Log unsupported resource type for manual review'
    inputs:
      Service: logs
      Api: PutLogEvents
      logGroupName: '/aws/ssm/imladris-remediation'
      logStreamName: 'unsupported-resources'
      logEvents:
        - timestamp: '{{ global:DATE_TIME }}'
          message: 'Unsupported resource type {{ resourceType }} with ID {{ resourceId }} requires manual remediation'
    isEnd: true

outputs:
  - RemediateSecurityGroup.ResponseMetadata
  - LogUnsupportedResource.ResponseMetadata