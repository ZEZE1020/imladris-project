schemaVersion: '0.3'
description: 'Remediate SSH access violations by removing public SSH ingress rules'
assumeRole: '{{ AutomationAssumeRole }}'
parameters:
  configRuleName:
    type: String
    description: 'Name of the Config rule that triggered this automation'
  resourceId:
    type: String
    description: 'Resource ID that is non-compliant'
  resourceType:
    type: String
    description: 'Type of resource that is non-compliant'
  AutomationAssumeRole:
    type: String
    description: 'IAM role for automation execution'
    default: 'arn:aws:iam::{{global:ACCOUNT_ID}}:role/imladris-{{ssm:environment}}-remediation-role'

mainSteps:
  - name: IdentifyResourceType
    action: 'aws:branch'
    inputs:
      Choices:
        - NextStep: RemediateSecurityGroup
          Variable: '{{ resourceType }}'
          StringEquals: 'AWS::EC2::SecurityGroup'
        - NextStep: LogUnsupportedResource
          Variable: '{{ resourceType }}'
          StringEquals: 'AWS::EC2::Instance'
      Default: LogUnsupportedResource

  - name: RemediateSecurityGroup
    action: 'aws:executeAwsApi'
    description: 'Revoke SSH ingress rules from security group'
    inputs:
      Service: ec2
      Api: RevokeSecurityGroupIngress
      GroupId: '{{ resourceId }}'
      IpPermissions:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          IpRanges:
            - CidrIp: '0.0.0.0/0'
    outputs:
      - Name: RevokeResult
        Selector: $.Return
        Type: Boolean
    isEnd: true
    onFailure: Continue

  - name: LogUnsupportedResource
    action: 'aws:sleep'
    description: 'Pause before logging unsupported resource type'
    inputs:
      Duration: PT1S
    isEnd: true